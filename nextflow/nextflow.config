/*
 * ASHS Nextflow Configuration
 *
 * This file defines execution profiles for different compute environments.
 * Select a profile with: nextflow run main.nf -profile <profile_name>
 *
 * Multiple profiles can be combined: -profile slurm,singularity
 */

// Pipeline manifest
manifest {
    name = 'ASHS'
    author = 'ASHS Team'
    description = 'Automatic Segmentation of Hippocampal Subfields'
    version = '2.0.0'
    nextflowVersion = '>=21.04.0'
    mainScript = 'main.nf'
}

// Default parameters
params {
    // Input/Output
    outdir = './results'
    tracedir = "${params.outdir}/pipeline_info"

    // Resource defaults
    max_memory = '128.GB'
    max_cpus = 16
    max_time = '72.h'

    // Container
    container = 'ashs:latest'
}

// Process defaults
process {
    // Error handling
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries = 2
    maxErrors = '-1'

    // Default resources
    cpus = 1
    memory = '4.GB'
    time = '4.h'

    // Process-specific labels
    withLabel: process_low {
        cpus = 1
        memory = '4.GB'
        time = '2.h'
    }
    withLabel: process_medium {
        cpus = 4
        memory = '8.GB'
        time = '8.h'
    }
    withLabel: process_high {
        cpus = 8
        memory = '16.GB'
        time = '24.h'
    }
}

// Execution profiles
profiles {

    // Local execution (default)
    standard {
        process.executor = 'local'
    }

    local {
        process.executor = 'local'
        executor {
            cpus = 8
            memory = '32.GB'
        }
    }

    // SLURM cluster
    slurm {
        process.executor = 'slurm'
        process.queue = 'normal'
        process.clusterOptions = ''

        // Uncomment and modify as needed:
        // process.clusterOptions = '--account=myaccount'

        executor {
            queueSize = 100
            submitRateLimit = '10 sec'
        }
    }

    // SGE cluster
    sge {
        process.executor = 'sge'
        process.penv = 'smp'

        // Uncomment and modify as needed:
        // process.queue = 'all.q'
        // process.clusterOptions = '-l h_vmem=8G'

        executor {
            queueSize = 100
        }
    }

    // LSF cluster
    lsf {
        process.executor = 'lsf'

        // Uncomment and modify as needed:
        // process.queue = 'normal'
        // process.clusterOptions = '-R "rusage[mem=8000]"'

        executor {
            queueSize = 100
            submitRateLimit = '10 sec'
        }
    }

    // PBS/Torque cluster
    pbs {
        process.executor = 'pbs'

        executor {
            queueSize = 100
        }
    }

    // AWS Batch
    awsbatch {
        process.executor = 'awsbatch'
        process.queue = 'ashs-queue'
        aws.region = 'us-east-1'
        aws.batch.cliPath = '/home/ec2-user/miniconda/bin/aws'
    }

    // Google Cloud Life Sciences
    google {
        process.executor = 'google-lifesciences'
        google.location = 'us-central1'
        google.region = 'us-central1'
        google.project = 'my-project'
    }

    // Docker container
    docker {
        docker.enabled = true
        docker.userEmulation = true
        singularity.enabled = false
        podman.enabled = false

        process.container = params.container
    }

    // Singularity container
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        docker.enabled = false
        podman.enabled = false

        process.container = "docker://${params.container}"

        // For HPC systems that require specific bind paths:
        // singularity.runOptions = '-B /scratch -B /data'
    }

    // Podman container
    podman {
        podman.enabled = true
        docker.enabled = false
        singularity.enabled = false

        process.container = params.container
    }

    // Test profile with minimal resources
    test {
        params.max_cpus = 2
        params.max_memory = '6.GB'
        params.max_time = '1.h'

        process {
            withLabel: process_low {
                cpus = 1
                memory = '1.GB'
            }
            withLabel: process_medium {
                cpus = 2
                memory = '2.GB'
            }
            withLabel: process_high {
                cpus = 2
                memory = '4.GB'
            }
        }
    }

    // Debug profile
    debug {
        process.beforeScript = 'echo "Starting task: $HOSTNAME"'
        process.afterScript = 'echo "Completed task: $HOSTNAME"'
        cleanup = false
    }
}

// Capture execution reports
timeline {
    enabled = true
    file = "${params.tracedir}/timeline.html"
}

report {
    enabled = true
    file = "${params.tracedir}/report.html"
}

trace {
    enabled = true
    file = "${params.tracedir}/trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
    enabled = true
    file = "${params.tracedir}/dag.svg"
}

// Function to check resource limits
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "WARNING: Invalid memory value: ${obj}"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "WARNING: Invalid time value: ${obj}"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min(obj, params.max_cpus as int)
        } catch (all) {
            println "WARNING: Invalid cpus value: ${obj}"
            return obj
        }
    }
}
